<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte personnalis√©e</title>
    <style>
        body {
            min-height: 100vh;
            display: grid; gap: 2rem;
            place-content: center;
        }
        .container {
            width: 500px;
            height: 500px;
            position: relative;
        }
        .container-image {
            display: block;
            max-width: 100%;
        }
        .container-profile {
            width: 165px;
            height: 165px;
            border-radius: 100%;
            position: absolute;
            top: 97px;
            left: 32px;
            object-fit: cover;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Image de fond statique -->
    <img class="container-image" src="img.jpg" alt="">
    <!-- Image de profil (vide au d√©part) -->
    <img class="container-profile" src="" alt="">
</div>

<div>
    <label><input type="file" id="fileInput"></label>
    <button class="download-btn" onclick="downloadCard()">
        üì• T√©l√©charger la carte (PNG)
    </button>
</div>

<script>
    // R√©cup√©rer l'input file et l'√©l√©ment <img> du profil
    const inputFile = document.getElementById('fileInput');
    const profileImg = document.querySelector('.container-profile');

    // Quand l'utilisateur choisit un fichier, on le lit et on l'affiche dans la balise <img>
    inputFile.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                profileImg.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // Fonction pour dessiner le canvas et t√©l√©charger l'image finale
    function downloadCard() {
        const background = new Image();
        const profile = new Image();

        // D√©finir les sources des images (fond et profil)
        background.src = document.querySelector('.container-image').src;
        profile.src = profileImg.src;

        // Compter le nombre d'images charg√©es
        let imagesLoaded = 0;
        function onImageLoad() {
            imagesLoaded++;
            if (imagesLoaded === 2) {
                // Toutes les images sont pr√™tes : on cr√©e le canvas de 500x500
                const container = document.querySelector('.container');
                const width = container.offsetWidth;
                const height = container.offsetHeight;
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // Dessiner l'image de fond
                ctx.drawImage(background, 0, 0, width, height);

                // Pr√©parer le cercle pour l'image de profil
                const style = getComputedStyle(profileImg);
                const px = parseFloat(style.left);
                const py = parseFloat(style.top);
                const pw = parseFloat(style.width);
                const ph = parseFloat(style.height);

                ctx.save();
                ctx.beginPath();
                ctx.arc(px + pw/2, py + ph/2, pw/2, 0, 2 * Math.PI);
                ctx.clip();

                // Adapter l'image de profil pour qu'elle couvre le cercle (object-fit: cover)
                const imgW = profile.width;
                const imgH = profile.height;
                if (imgW > imgH) {
                    // Image plus large que haute
                    const scaledH = ph;
                    const scale = scaledH / imgH;
                    const scaledW = imgW * scale;
                    // Centrer horizontalement le cadrage
                    const dx = px - (scaledW - pw) / 2;
                    ctx.drawImage(profile, dx, py, scaledW, scaledH);
                } else {
                    // Image plus haute que large
                    const scaledW = pw;
                    const scale = scaledW / imgW;
                    const scaledH = imgH * scale;
                    // Centrer verticalement le cadrage
                    const dy = py - (scaledH - ph) / 2;
                    ctx.drawImage(profile, px, dy, scaledW, scaledH);
                }
                ctx.restore();

                // G√©n√©rer le lien de t√©l√©chargement
                const link = document.createElement('a');
                link.download = 'carte.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }

        // Attacher les callbacks de chargement
        background.onload = onImageLoad;
        profile.onload = onImageLoad;
    }
</script>
</body>
</html>
